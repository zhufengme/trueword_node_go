# line create - åˆ›å»ºéš§é“

## æ¦‚è¿°

`line create` å‘½ä»¤ç”¨äºåˆ›å»º GRE over IPsec æˆ– WireGuard éš§é“ã€‚æ”¯æŒäº¤äº’å¼å’Œå‘½ä»¤è¡Œä¸¤ç§æ¨¡å¼ã€‚

## è¯­æ³•

### äº¤äº’å¼æ¨¡å¼ï¼ˆæ¨èç”¨äºåˆå­¦è€…ï¼‰

```bash
sudo twnode line create
```

ç³»ç»Ÿä¼šå¼•å¯¼ä½ å®Œæˆé…ç½®ã€‚

### å‘½ä»¤è¡Œæ¨¡å¼

#### WireGuard æœåŠ¡å™¨æ¨¡å¼

```bash
sudo twnode line create <çˆ¶æ¥å£> 0.0.0.0 <å¯¹ç«¯VIP> <æœ¬åœ°VIP> <éš§é“å> \
  --type wireguard \
  --mode server \
  --listen-port <ç«¯å£>
```

#### WireGuard å®¢æˆ·ç«¯æ¨¡å¼

```bash
sudo twnode line create <çˆ¶æ¥å£> <å¯¹ç«¯IP> <å¯¹ç«¯VIP> <æœ¬åœ°VIP> <éš§é“å> \
  --type wireguard \
  --mode client \
  --private-key '<ç§é’¥>' \
  --peer-pubkey '<å¯¹ç«¯å…¬é’¥>' \
  --peer-port <ç«¯å£>
```

#### GRE over IPsec

```bash
sudo twnode line create <çˆ¶æ¥å£> <å¯¹ç«¯IP> <å¯¹ç«¯VIP> <æœ¬åœ°VIP> <éš§é“å> \
  --auth-key '<è®¤è¯å¯†é’¥>' \
  --enc-key '<åŠ å¯†å¯†é’¥>'
```

## å‚æ•°è¯´æ˜

### ä½ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `<çˆ¶æ¥å£>` | åº•å±‚ä¼ è¾“æ¥å£ï¼ˆç‰©ç†æ¥å£æˆ–å·²åˆ›å»ºçš„éš§é“ï¼‰ | `eth0`, `tun01` |
| `<å¯¹ç«¯IP>` | å¯¹ç«¯çœŸå® IP åœ°å€ï¼ˆWireGuard æœåŠ¡å™¨æ¨¡å¼ä½¿ç”¨ `0.0.0.0`ï¼‰ | `203.0.113.50`, `0.0.0.0` |
| `<å¯¹ç«¯VIP>` | å¯¹ç«¯è™šæ‹Ÿ IP åœ°å€ | `10.0.0.2` |
| `<æœ¬åœ°VIP>` | æœ¬åœ°è™šæ‹Ÿ IP åœ°å€ | `10.0.0.1` |
| `<éš§é“å>` | éš§é“æ¥å£åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤è‡ªåŠ¨ç”Ÿæˆï¼‰ | `tunnel_ab` |

### é€‰é¡¹å‚æ•°

#### é€šç”¨é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--type` | éš§é“ç±»å‹ï¼š`gre`ï¼ˆGRE over IPsecï¼‰æˆ– `wireguard` | `gre` |

#### WireGuard é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ | é€‚ç”¨æ¨¡å¼ |
|------|------|----------|
| `--mode` | WireGuard æ¨¡å¼ï¼š`server` æˆ– `client` | å¿…éœ€ |
| `--listen-port` | æœ¬åœ°ç›‘å¬ç«¯å£ | æœåŠ¡å™¨æ¨¡å¼å¿…éœ€ |
| `--private-key` | æœ¬åœ°ç§é’¥ï¼ˆBase64 ç¼–ç ï¼‰ | å®¢æˆ·ç«¯æ¨¡å¼å¿…éœ€ |
| `--peer-pubkey` | å¯¹ç«¯å…¬é’¥ï¼ˆBase64 ç¼–ç ï¼‰ | å®¢æˆ·ç«¯æ¨¡å¼å¿…éœ€ |
| `--peer-port` | å¯¹ç«¯ç›‘å¬ç«¯å£ | å®¢æˆ·ç«¯æ¨¡å¼å¿…éœ€ |

#### GRE over IPsec é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--auth-key` | IPsec è®¤è¯å¯†é’¥ï¼ˆåå…­è¿›åˆ¶ï¼Œå¯é€‰ `0x` å‰ç¼€ï¼‰ | äº¤äº’æ¨¡å¼æç¤ºè¾“å…¥ |
| `--enc-key` | IPsec åŠ å¯†å¯†é’¥ï¼ˆåå…­è¿›åˆ¶ï¼Œå¯é€‰ `0x` å‰ç¼€ï¼‰ | äº¤äº’æ¨¡å¼æç¤ºè¾“å…¥ |
| `--no-encryption` | ç¦ç”¨ IPsec åŠ å¯†ï¼ˆä»… GREï¼‰ | å¯ç”¨åŠ å¯† |

## å·¥ä½œæµç¨‹

### WireGuard æœåŠ¡å™¨æ¨¡å¼

```
1. éªŒè¯çˆ¶æ¥å£å­˜åœ¨æ€§
   â””â”€ æ£€æŸ¥çˆ¶æ¥å£æ˜¯ç‰©ç†æ¥å£è¿˜æ˜¯å·²åˆ›å»ºçš„éš§é“

2. è‡ªåŠ¨ä»çˆ¶æ¥å£è·å–æœ¬åœ° IP
   â”œâ”€ ç‰©ç†æ¥å£ â†’ ä½¿ç”¨ç‰©ç†æ¥å£çš„ IP
   â””â”€ éš§é“æ¥å£ â†’ ä½¿ç”¨éš§é“çš„ LocalVIP

3. ç”Ÿæˆæœ¬åœ°å¯†é’¥å¯¹ï¼ˆç§é’¥A + å…¬é’¥Aï¼‰

4. ç”Ÿæˆå¯¹ç«¯å¯†é’¥å¯¹ï¼ˆç§é’¥B + å…¬é’¥Bï¼‰

5. åˆ›å»º WireGuard æ¥å£
   â”œâ”€ æ·»åŠ æ¥å£ï¼šip link add <name> type wireguard
   â”œâ”€ é…ç½®ç§é’¥ï¼šwg set <name> private-key <ç§é’¥A>
   â”œâ”€ é…ç½®ç›‘å¬ç«¯å£ï¼šwg set <name> listen-port <port>
   â””â”€ é…ç½®å¯¹ç«¯ï¼šwg set <name> peer <å…¬é’¥B> allowed-ips <å¯¹ç«¯VIP>/32

6. é…ç½®è™šæ‹Ÿ IP
   â”œâ”€ æ·»åŠ åœ°å€ï¼šip addr add <æœ¬åœ°VIP>/32 dev <name>
   â””â”€ å¯åŠ¨æ¥å£ï¼šip link set <name> up

7. æ·»åŠ è™šæ‹Ÿ IP è·¯ç”±è§„åˆ™
   â””â”€ ip rule add to <å¯¹ç«¯VIP>/32 lookup 80 pref 80

8. æ·»åŠ ä¿æŠ¤è·¯ç”±ï¼ˆå ä½ç¬¦ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥åæ›´æ–°ï¼‰
   â””â”€ ä¼˜å…ˆçº§ 10ï¼Œç¡®ä¿éš§é“åº•å±‚è¿æ¥ä¸èµ°ç­–ç•¥è·¯ç”±

9. ä¿å­˜é…ç½®åˆ°æ–‡ä»¶
   â””â”€ /etc/trueword_node/tunnels/<name>.yaml

10. è¾“å‡ºå¯¹ç«¯é…ç½®å‘½ä»¤
    â””â”€ åŒ…å«ç§é’¥Bå’Œå…¬é’¥Aï¼Œä¾›å¯¹ç«¯æœåŠ¡å™¨ä½¿ç”¨
```

### WireGuard å®¢æˆ·ç«¯æ¨¡å¼

```
1-2. ï¼ˆåŒæœåŠ¡å™¨æ¨¡å¼ï¼‰

3. ä½¿ç”¨æœåŠ¡å™¨æä¾›çš„å¯†é’¥
   â”œâ”€ æœ¬åœ°ç§é’¥ï¼š--private-key
   â””â”€ å¯¹ç«¯å…¬é’¥ï¼š--peer-pubkey

4. åˆ›å»º WireGuard æ¥å£
   â”œâ”€ æ·»åŠ æ¥å£
   â”œâ”€ é…ç½®ç§é’¥
   â”œâ”€ é…ç½®å¯¹ç«¯ï¼špeer <å¯¹ç«¯å…¬é’¥> endpoint <å¯¹ç«¯IP>:<ç«¯å£> allowed-ips <å¯¹ç«¯VIP>/32
   â””â”€ é…ç½® persistent-keepalive 25ï¼ˆä¿æŒè¿æ¥ï¼‰

5-9. ï¼ˆåŒæœåŠ¡å™¨æ¨¡å¼ï¼‰

10. ä¸»åŠ¨è§¦å‘æ¡æ‰‹
    â””â”€ å‘é€ ping åŒ…åˆ°å¯¹ç«¯ VIPï¼Œè§¦å‘ WireGuard æ¡æ‰‹
```

### GRE over IPsec

```
1-2. ï¼ˆåŒ WireGuardï¼‰

3. è®¾ç½®ç­–ç•¥è·¯ç”±ï¼ˆä»…ç‰©ç†æ¥å£ï¼‰
   â””â”€ ç¡®ä¿å¯¹ç«¯ IP é€šè¿‡æ­£ç¡®çš„ç‰©ç†æ¥å£è·¯ç”±

4. åˆ›å»º IPsec è¿æ¥ï¼ˆå¦‚æœå¯ç”¨åŠ å¯†ï¼‰
   â”œâ”€ ç”Ÿæˆå¯¹ç§° SPIï¼ˆåŸºäº IP å¯¹ï¼‰
   â”œâ”€ æ·»åŠ  XFRM stateï¼ˆinbound + outboundï¼‰
   â””â”€ æ·»åŠ  XFRM policyï¼ˆinbound + outboundï¼‰

5. åˆ›å»º GRE éš§é“
   â”œâ”€ ç”Ÿæˆ GRE Keyï¼ˆä»è®¤è¯å¯†é’¥ç”Ÿæˆï¼Œç¡®ä¿å¯¹ç§°æ€§ï¼‰
   â”œâ”€ æ·»åŠ  GRE æ¥å£ï¼šip tunnel add <name> mode gre ...
   â”œâ”€ é…ç½®è™šæ‹Ÿ IPï¼šip addr add <æœ¬åœ°VIP>/32 dev <name>
   â””â”€ å¯åŠ¨æ¥å£ï¼šip link set <name> up

6-9. ï¼ˆåŒ WireGuardï¼‰
```

## ç¤ºä¾‹

### ç¤ºä¾‹1: WireGuard æœåŠ¡å™¨æ¨¡å¼

**æœåŠ¡å™¨ A**ï¼ˆ192.168.1.100ï¼‰:

```bash
sudo twnode line create eth0 0.0.0.0 10.0.0.2 10.0.0.1 tunnel_ab \
  --type wireguard \
  --mode server \
  --listen-port 51820
```

**è¾“å‡º**:

```
âœ“ å·²åˆ›å»º WireGuard éš§é“: tunnel_ab

ã€å¯¹ç«¯é…ç½®å‘½ä»¤ã€‘
åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºå¯¹åº”çš„éš§é“:

sudo twnode line create <çˆ¶æ¥å£> 192.168.1.100 10.0.0.1 10.0.0.2 tunnel_ba \
  --type wireguard \
  --mode client \
  --private-key 'aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD8e=' \
  --peer-pubkey 'xY9zA0bC1dE2fG3hI4jK5lM6nO7pQ8rS9tU0vW1xY2zA4=' \
  --peer-port 51820

ğŸ’¡ å¯¹ç«¯é…ç½®å·²ä¿å­˜åˆ°: /var/lib/trueword_node/peer_configs/tunnel_ab.txt

æç¤º: ä½¿ç”¨ 'twnode line show-peer tunnel_ab' å¯å†æ¬¡æŸ¥çœ‹å¯¹ç«¯é…ç½®
```

### ç¤ºä¾‹2: WireGuard å®¢æˆ·ç«¯æ¨¡å¼

**æœåŠ¡å™¨ B**ï¼ˆ203.0.113.50ï¼‰:

å¤åˆ¶æœåŠ¡å™¨ A è¾“å‡ºçš„å‘½ä»¤ï¼Œæ›¿æ¢ `<çˆ¶æ¥å£>` ä¸ºå®é™…æ¥å£ï¼š

```bash
sudo twnode line create eth0 192.168.1.100 10.0.0.1 10.0.0.2 tunnel_ba \
  --type wireguard \
  --mode client \
  --private-key 'aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD8e=' \
  --peer-pubkey 'xY9zA0bC1dE2fG3hI4jK5lM6nO7pQ8rS9tU0vW1xY2zA4=' \
  --peer-port 51820
```

**è¾“å‡º**:

```
âœ“ å·²åˆ›å»º WireGuard éš§é“: tunnel_ba
âœ“ é…ç½®å·²ä¿å­˜åˆ° /etc/trueword_node/tunnels/tunnel_ba.yaml
```

### ç¤ºä¾‹3: GRE over IPsecï¼ˆäº¤äº’å¼ï¼‰

```bash
$ sudo twnode line create

ã€åˆ›å»ºéš§é“ã€‘

å¯ç”¨çš„çˆ¶æ¥å£:
1. eth0 (192.168.1.100)
2. eth1 (10.0.0.50)
3. tunnel_ab (10.0.0.1)

è¯·é€‰æ‹©çˆ¶æ¥å£ï¼ˆè¾“å…¥åºå·ï¼‰: 1

éš§é“ç±»å‹:
1. GRE over IPsecï¼ˆä¼ ç»ŸåŒå±‚éš§é“ï¼‰
2. WireGuardï¼ˆç°ä»£ VPNï¼‰

è¯·é€‰æ‹©éš§é“ç±»å‹ï¼ˆè¾“å…¥åºå·ï¼Œé»˜è®¤ 1ï¼‰: 1

è¯·è¾“å…¥å¯¹ç«¯ IP åœ°å€: 203.0.113.50
è¯·è¾“å…¥å¯¹ç«¯è™šæ‹Ÿ IP: 10.0.1.2
è¯·è¾“å…¥æœ¬åœ°è™šæ‹Ÿ IP: 10.0.1.1
è¯·è¾“å…¥éš§é“åç§°ï¼ˆé»˜è®¤è‡ªåŠ¨ç”Ÿæˆï¼‰: tunnel_cd
è¯·è¾“å…¥è®¤è¯å¯†é’¥ï¼ˆåå…­è¿›åˆ¶ï¼‰: 0x1234567890abcdef
è¯·è¾“å…¥åŠ å¯†å¯†é’¥ï¼ˆåå…­è¿›åˆ¶ï¼‰: 0xfedcba0987654321

ã€é…ç½®ä¿¡æ¯ã€‘
çˆ¶æ¥å£: eth0
æœ¬åœ° IP: 192.168.1.100 (è‡ªåŠ¨è·å–)
å¯¹ç«¯ IP: 203.0.113.50
æœ¬åœ° VIP: 10.0.1.1
å¯¹ç«¯ VIP: 10.0.1.2
éš§é“åç§°: tunnel_cd

ã€å»ºç«‹è¿æ¥ã€‘
âœ“ è®¾ç½®ç­–ç•¥è·¯ç”±
âœ“ åˆ›å»º IPsec è¿æ¥
âœ“ åˆ›å»º GRE éš§é“
âœ“ é…ç½®è™šæ‹Ÿ IP
âœ“ æ·»åŠ è·¯ç”±è§„åˆ™
âœ“ æ·»åŠ ä¿æŠ¤è·¯ç”±

âœ“ éš§é“åˆ›å»ºæˆåŠŸï¼
âœ“ é…ç½®å·²ä¿å­˜åˆ° /etc/trueword_node/tunnels/tunnel_cd.yaml
```

### ç¤ºä¾‹4: å¤šå±‚éš§é“åµŒå¥—

```bash
# ç¬¬ä¸€å±‚ï¼šåŸºäºç‰©ç†æ¥å£ eth0
sudo twnode line create eth0 203.0.113.50 10.0.0.2 10.0.0.1 tun01

# ç¬¬äºŒå±‚ï¼šåŸºäºéš§é“ tun01
sudo twnode line create tun01 10.0.0.2 172.16.0.2 172.16.0.1 tun02 \
  --type wireguard --mode server --listen-port 51821

# ç¬¬ä¸‰å±‚ï¼šåŸºäºéš§é“ tun02
sudo twnode line create tun02 172.16.0.2 192.168.100.2 192.168.100.1 tun03
```

**éš§é“é“¾**:
```
eth0 (192.168.1.100)
  â””â”€ tun01 (10.0.0.1)
      â””â”€ tun02 (172.16.0.1)
          â””â”€ tun03 (192.168.100.1)
```

### ç¤ºä¾‹5: GRE ä¸åŠ å¯†ï¼ˆä»… GREï¼‰

```bash
sudo twnode line create eth0 203.0.113.50 10.0.2.2 10.0.2.1 tunnel_plain \
  --no-encryption
```

**æ³¨æ„**: ä¸åŠ å¯†çš„ GRE éš§é“æµé‡æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œä»…é€‚ç”¨äºå¯ä¿¡ç½‘ç»œç¯å¢ƒã€‚

## é…ç½®æ–‡ä»¶

éš§é“é…ç½®ä¿å­˜åœ¨ `/etc/trueword_node/tunnels/<name>.yaml`ï¼š

### WireGuard é…ç½®ç¤ºä¾‹

```yaml
name: tunnel_ab
parent_interface: eth0
tunnel_type: wireguard
local_ip: 192.168.1.100
remote_ip: 0.0.0.0  # æœåŠ¡å™¨æ¨¡å¼å ä½ç¬¦
local_vip: 10.0.0.1
remote_vip: 10.0.0.2
protected_ip: ""    # å®¢æˆ·ç«¯è¿æ¥åæ›´æ–°

listen_port: 51820
private_key: xY9zA0bC1dE2fG3hI4jK5lM6nO7pQ8rS9tU0vW1xY2zA4=
peer_pubkey: aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD8e=
peer_port: 0        # æœåŠ¡å™¨æ¨¡å¼ä¸éœ€è¦
```

### GRE over IPsec é…ç½®ç¤ºä¾‹

```yaml
name: tunnel_cd
parent_interface: eth0
tunnel_type: gre
local_ip: 192.168.1.100
remote_ip: 203.0.113.50
local_vip: 10.0.1.1
remote_vip: 10.0.1.2
protected_ip: 203.0.113.50

auth_key: 0x1234567890abcdef
enc_key: 0xfedcba0987654321
encryption_enabled: true
```

## æ’¤é”€å‘½ä»¤

æ¯ä¸ªéš§é“çš„æ’¤é”€å‘½ä»¤ä¿å­˜åœ¨ `/var/lib/trueword_node/rev/<name>.rev`ï¼š

```bash
# tunnel_ab.rev ç¤ºä¾‹
ip link set tunnel_ab down
ip link del tunnel_ab
ip rule del to 10.0.0.2/32 lookup 80 pref 80
```

åˆ é™¤éš§é“æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™äº›æ’¤é”€å‘½ä»¤ã€‚

## å¸¸è§é—®é¢˜

### Q: çˆ¶æ¥å£å¿…é¡»æ˜¯ä»€ä¹ˆï¼Ÿ

A: çˆ¶æ¥å£å¯ä»¥æ˜¯**ç‰©ç†ç½‘ç»œæ¥å£**ï¼ˆå¦‚ eth0ï¼‰æˆ–**å·²åˆ›å»ºçš„éš§é“**ï¼ˆå¦‚ tun01ï¼‰ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ä»çˆ¶æ¥å£è·å–æœ¬åœ° IPã€‚

### Q: WireGuard æœåŠ¡å™¨æ¨¡å¼ä¸ºä»€ä¹ˆå¯¹ç«¯ IP æ˜¯ 0.0.0.0ï¼Ÿ

A: æœåŠ¡å™¨æ¨¡å¼ä¸çŸ¥é“å®¢æˆ·ç«¯çš„ IP åœ°å€ï¼ˆå°¤å…¶æ˜¯åŠ¨æ€ IP åœºæ™¯ï¼‰ã€‚å®¢æˆ·ç«¯é¦–æ¬¡è¿æ¥åï¼ŒæœåŠ¡å™¨é€šè¿‡ `wg show` è·å–å®é™…å¯¹ç«¯ IPï¼Œå¹¶åœ¨ `policy sync-protection` æ—¶æ›´æ–°ä¿æŠ¤è·¯ç”±ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹ WireGuard å¯¹ç«¯é…ç½®å‘½ä»¤ï¼Ÿ

A: ä½¿ç”¨ `twnode line show-peer <éš§é“å>` æŸ¥çœ‹å·²ä¿å­˜çš„å¯¹ç«¯é…ç½®å‘½ä»¤ã€‚

### Q: GRE Key å¦‚ä½•ä¿è¯å¯¹ç§°æ€§ï¼Ÿ

A: GRE Key é€šè¿‡å¯¹è®¤è¯å¯†é’¥å­—ç¬¦ä¸²æ±‚å’Œç”Ÿæˆï¼Œç¡®ä¿ä¸¤ç«¯ä½¿ç”¨ç›¸åŒçš„è®¤è¯å¯†é’¥æ—¶ç”Ÿæˆç›¸åŒçš„ GRE Keyã€‚

### Q: IPsec SPI å¦‚ä½•ä¿è¯å¯¹ç§°æ€§ï¼Ÿ

A: SPI é€šè¿‡å¯¹ IP å¯¹æ’åºåè®¡ç®— MD5 å“ˆå¸Œç”Ÿæˆï¼Œç¡®ä¿æ— è®ºåœ¨å“ªç«¯åˆ›å»ºéƒ½ç”Ÿæˆç›¸åŒçš„ SPIã€‚

### Q: å¯ä»¥åˆ›å»ºåŒåéš§é“å—ï¼Ÿ

A: ä¸å¯ä»¥ã€‚éš§é“åç§°å¿…é¡»å”¯ä¸€ã€‚å¦‚æœå·²å­˜åœ¨åŒåéš§é“ï¼Œåˆ›å»ºä¼šå¤±è´¥ã€‚

### Q: åˆ›å»ºåéš§é“è‡ªåŠ¨å¯åŠ¨å—ï¼Ÿ

A: ä¸ä¼šã€‚åˆ›å»ºåéš§é“å¤„äº inactive çŠ¶æ€ï¼Œéœ€è¦ä½¿ç”¨ `twnode line start <name>` å¯åŠ¨ã€‚

## ä¸‹ä¸€æ­¥

- [å¯åŠ¨éš§é“](start.md) - å¯åŠ¨å·²åˆ›å»ºçš„éš§é“
- [æ£€æŸ¥è¿é€šæ€§](check.md) - æµ‹è¯•éš§é“è¿é€šæ€§å’Œå»¶è¿Ÿ
- [WireGuard å®Œæ•´æ•™ç¨‹](../../tutorials/wireguard-setup.md)
- [GRE over IPsec å®Œæ•´æ•™ç¨‹](../../tutorials/gre-ipsec-setup.md)

---

**å¯¼èˆª**: [â† line å‘½ä»¤](index.md) | [è¿”å›é¦–é¡µ](../../index.md) | [start â†’](start.md)
