# å¿«é€Ÿå…¥é—¨

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ åœ¨ 5 åˆ†é’Ÿå†…å®Œæˆ TrueWord Node çš„å®‰è£…å’ŒåŸºæœ¬é…ç½®ã€‚

## å‰ç½®è¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linuxï¼ˆä»»ä½•å‘è¡Œç‰ˆï¼‰
- **æƒé™**: root æˆ– sudo æƒé™
- **å†…æ ¸**: æ”¯æŒ GRE å’Œ XFRMï¼ˆå¤§å¤šæ•°ç°ä»£ Linux å†…æ ¸éƒ½æ”¯æŒï¼‰

### å¿…éœ€å·¥å…·
- `ip` - ç½‘ç»œé…ç½®å·¥å…·ï¼ˆiproute2 åŒ…ï¼‰
- `iptables` - é˜²ç«å¢™å·¥å…·
- `ping` - ç½‘ç»œè¿é€šæ€§æµ‹è¯•
- `sysctl` - å†…æ ¸å‚æ•°é…ç½®

> ğŸ’¡ **æç¤º**: è¿™äº›å·¥å…·åœ¨å¤§å¤šæ•° Linux å‘è¡Œç‰ˆä¸­éƒ½å·²é¢„è£…ã€‚

## å®‰è£…æ­¥éª¤

### 1. è·å–æºä»£ç 

```bash
git clone https://github.com/your-org/trueword_node_go.git
cd trueword_node_go
```

### 2. ç¼–è¯‘

**é‡è¦**: å§‹ç»ˆä½¿ç”¨é™æ€ç¼–è¯‘ï¼Œç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶å¯åœ¨ä»»ä½• Linux ç³»ç»Ÿä¸Šè¿è¡Œã€‚

```bash
# é™æ€ç¼–è¯‘ï¼ˆæ¨èï¼‰
make static

# éªŒè¯é™æ€ç¼–è¯‘
file bin/twnode
# åº”è¾“å‡º: bin/twnode: ELF 64-bit LSB executable, ... statically linked ...

ldd bin/twnode
# åº”è¾“å‡º: not a dynamic executable
```

### 3. å®‰è£…åˆ°ç³»ç»Ÿ

```bash
sudo make install
# äºŒè¿›åˆ¶æ–‡ä»¶å°†å®‰è£…åˆ° /usr/local/bin/twnode
```

### 4. éªŒè¯å®‰è£…

```bash
twnode --version
# åº”æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

## ç³»ç»Ÿåˆå§‹åŒ–

### è¿è¡Œ init å‘½ä»¤

é¦–æ¬¡ä½¿ç”¨å¿…é¡»è¿è¡Œåˆå§‹åŒ–å‘½ä»¤ï¼š

```bash
sudo twnode init
```

### åˆå§‹åŒ–æµç¨‹

åˆå§‹åŒ–è¿‡ç¨‹ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. âœ… æ£€æŸ¥ root æƒé™
2. âœ… æ£€æŸ¥å¿…éœ€å‘½ä»¤ï¼ˆip, iptables, ping, sysctlï¼‰
3. âœ… å¯ç”¨ IP è½¬å‘ï¼ˆ`net.ipv4.ip_forward=1`ï¼‰
4. âœ… é…ç½® iptables MASQUERADE
5. âœ… æ‰«æç‰©ç†ç½‘ç»œæ¥å£
6. âœ… äº¤äº’å¼é€‰æ‹©è¦ç®¡ç†çš„æ¥å£
7. âœ… åˆ›å»ºé…ç½®ç›®å½•ç»“æ„

### äº¤äº’ç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    TrueWord Node ç³»ç»Ÿåˆå§‹åŒ–å‘å¯¼     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ æ£€æŸ¥ root æƒé™...
âœ“ æ£€æŸ¥å¿…éœ€å‘½ä»¤...
âœ“ å¯ç”¨ IP è½¬å‘...
âœ“ é…ç½® iptables MASQUERADE...

ã€æ‰«æç½‘ç»œæ¥å£ã€‘
æ‰¾åˆ°ä»¥ä¸‹ç½‘ç»œæ¥å£:

åºå·  æ¥å£å    IP åœ°å€           ç½‘å…³
----  ------    ---------------  ---------------
1     eth0      192.168.1.100    192.168.1.1
2     eth1      10.0.0.50        10.0.0.1

è¯·é€‰æ‹©è¦ç®¡ç†çš„æ¥å£ï¼ˆè¾“å…¥åºå·ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚ 1,2ï¼‰: 1

âœ“ å·²é€‰æ‹©æ¥å£: eth0
âœ“ é…ç½®å·²ä¿å­˜åˆ° /etc/trueword_node/interfaces/physical.yaml
âœ“ åˆå§‹åŒ–å®Œæˆï¼
```

> âš ï¸ **æ³¨æ„**: å¦‚æœå·²æœ‰æ—§é…ç½®ï¼Œinit ä¼šè­¦å‘Šå¹¶è¦æ±‚ç¡®è®¤ï¼ˆå¿…é¡»è¾“å…¥ "yes"ï¼‰æ‰ä¼šæ¸…é™¤ã€‚

## ç¬¬ä¸€ä¸ªéš§é“

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„ WireGuard éš§é“ã€‚

### åœºæ™¯è¯´æ˜

å‡è®¾ä½ æœ‰ä¸¤å°æœåŠ¡å™¨ï¼š

- **æœåŠ¡å™¨ A**ï¼ˆæœ¬åœ°ï¼‰: `eth0 = 192.168.1.100`
- **æœåŠ¡å™¨ B**ï¼ˆè¿œç¨‹ï¼‰: å…¬ç½‘ IP `203.0.113.50`

æˆ‘ä»¬è¦åœ¨ä¸¤å°æœåŠ¡å™¨ä¹‹é—´å»ºç«‹ WireGuard éš§é“ï¼š

- æœåŠ¡å™¨ A è™šæ‹Ÿ IP: `10.0.0.1`
- æœåŠ¡å™¨ B è™šæ‹Ÿ IP: `10.0.0.2`

### æœåŠ¡å™¨ A æ“ä½œï¼ˆæœåŠ¡å™¨æ¨¡å¼ï¼‰

```bash
sudo twnode line create eth0 0.0.0.0 10.0.0.2 10.0.0.1 tunnel_ab \
  --type wireguard \
  --mode server \
  --listen-port 51820
```

**å‚æ•°è¯´æ˜**:
- `eth0` - çˆ¶æ¥å£ï¼ˆç‰©ç†æ¥å£ï¼‰
- `0.0.0.0` - å¯¹ç«¯ IPï¼ˆæœåŠ¡å™¨æ¨¡å¼ä½¿ç”¨å ä½ç¬¦ï¼‰
- `10.0.0.2` - å¯¹ç«¯è™šæ‹Ÿ IP
- `10.0.0.1` - æœ¬åœ°è™šæ‹Ÿ IP
- `tunnel_ab` - éš§é“åç§°

**è¾“å‡ºç¤ºä¾‹**:

```
âœ“ å·²åˆ›å»º WireGuard éš§é“: tunnel_ab

ã€å¯¹ç«¯é…ç½®å‘½ä»¤ã€‘
åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºå¯¹åº”çš„éš§é“:

sudo twnode line create <çˆ¶æ¥å£> 192.168.1.100 10.0.0.1 10.0.0.2 tunnel_ba \
  --type wireguard \
  --mode client \
  --private-key 'aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD8e=' \
  --peer-pubkey 'xY9zA0bC1dE2fG3hI4jK5lM6nO7pQ8rS9tU0vW1xY2zA4=' \
  --peer-port 51820

ğŸ’¡ å¯¹ç«¯é…ç½®å·²ä¿å­˜åˆ°: /var/lib/trueword_node/peer_configs/tunnel_ab.txt
```

### æœåŠ¡å™¨ B æ“ä½œï¼ˆå®¢æˆ·ç«¯æ¨¡å¼ï¼‰

å¤åˆ¶æœåŠ¡å™¨ A è¾“å‡ºçš„å‘½ä»¤ï¼Œæ›¿æ¢ `<çˆ¶æ¥å£>` ä¸ºå®é™…æ¥å£ï¼ˆå¦‚ `eth0`ï¼‰ï¼š

```bash
sudo twnode line create eth0 192.168.1.100 10.0.0.1 10.0.0.2 tunnel_ba \
  --type wireguard \
  --mode client \
  --private-key 'aB3cD4eF5gH6iJ7kL8mN9oP0qR1sT2uV3wX4yZ5aB6cD8e=' \
  --peer-pubkey 'xY9zA0bC1dE2fG3hI4jK5lM6nO7pQ8rS9tU0vW1xY2zA4=' \
  --peer-port 51820
```

### å¯åŠ¨éš§é“

åœ¨**ä¸¤å°æœåŠ¡å™¨**ä¸Šåˆ†åˆ«è¿è¡Œï¼š

```bash
# æœåŠ¡å™¨ A
sudo twnode line start tunnel_ab

# æœåŠ¡å™¨ B
sudo twnode line start tunnel_ba
```

### éªŒè¯è¿é€šæ€§

åœ¨æœåŠ¡å™¨ A ä¸Š ping æœåŠ¡å™¨ B çš„è™šæ‹Ÿ IPï¼š

```bash
ping 10.0.0.2
```

åœ¨æœåŠ¡å™¨ B ä¸Š ping æœåŠ¡å™¨ A çš„è™šæ‹Ÿ IPï¼š

```bash
ping 10.0.0.1
```

å¦‚æœèƒ½ ping é€šï¼Œæ­å–œï¼éš§é“å·²æˆåŠŸå»ºç«‹ ğŸ‰

### ä½¿ç”¨ check å‘½ä»¤æ£€æŸ¥

```bash
sudo twnode line check tunnel_ab 8.8.8.8
```

**è¾“å‡ºç¤ºä¾‹**:

```
ã€è¿é€šæ€§æ£€æŸ¥ç»“æœã€‘
æ¥å£åç§°: tunnel_ab
æµ‹è¯•åœ°å€: 8.8.8.8
ä¸¢åŒ…ç‡: 0%
å¹³å‡å»¶è¿Ÿ: 15.3 ms
è¯„åˆ†: 96.2 åˆ†
çŠ¶æ€: âœ“ è‰¯å¥½
```

## é…ç½®ç­–ç•¥è·¯ç”±

å‡è®¾ä½ æƒ³è®©æŸäº›æµé‡é€šè¿‡éš§é“è½¬å‘ã€‚

### 1. åˆ›å»ºç­–ç•¥ç»„

```bash
sudo twnode policy create vpn_traffic tunnel_ab
```

### 2. æ·»åŠ è·¯ç”±è§„åˆ™

```bash
# æ·»åŠ å•ä¸ª IP
sudo twnode policy add-cidr vpn_traffic 192.168.100.5/32

# æ·»åŠ  IP æ®µ
sudo twnode policy add-cidr vpn_traffic 192.168.100.0/24
```

### 3. åº”ç”¨ç­–ç•¥

```bash
sudo twnode policy apply vpn_traffic
```

### 4. éªŒè¯ç­–ç•¥

```bash
# æŸ¥çœ‹ç­–ç•¥ç»„åˆ—è¡¨
sudo twnode policy list

# æµ‹è¯•è·¯ç”±
# ä» 192.168.100.5 è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œæµé‡åº”è¯¥é€šè¿‡ tunnel_ab
```

### 5. æ’¤é”€ç­–ç•¥ï¼ˆå¯é€‰ï¼‰

```bash
sudo twnode policy revoke vpn_traffic
```

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### éš§é“ç®¡ç†

```bash
# åˆ—å‡ºæ‰€æœ‰éš§é“
sudo twnode line list

# å¯åŠ¨éš§é“
sudo twnode line start <éš§é“å>

# å¯åŠ¨æ‰€æœ‰éš§é“
sudo twnode line start-all

# åœæ­¢éš§é“
sudo twnode line stop <éš§é“å>

# åœæ­¢æ‰€æœ‰éš§é“
sudo twnode line stop-all

# åˆ é™¤éš§é“
sudo twnode line delete <éš§é“å>

# æ£€æŸ¥è¿é€šæ€§
sudo twnode line check <éš§é“å> <æµ‹è¯•IP>
```

### ç­–ç•¥è·¯ç”±

```bash
# åˆ›å»ºç­–ç•¥ç»„
sudo twnode policy create <ç»„å> <å‡ºå£æ¥å£>

# æ·»åŠ  CIDR
sudo twnode policy add-cidr <ç»„å> <CIDR>

# åˆ—å‡ºç­–ç•¥ç»„
sudo twnode policy list

# åº”ç”¨ç­–ç•¥
sudo twnode policy apply [ç»„å]

# æ’¤é”€ç­–ç•¥
sudo twnode policy revoke [ç»„å]

# åˆ é™¤ç­–ç•¥ç»„
sudo twnode policy delete <ç»„å>
```

## é…ç½®æ–‡ä»¶ä½ç½®

```
/etc/trueword_node/
â”œâ”€â”€ config.yaml              # å…¨å±€é…ç½®
â”œâ”€â”€ interfaces/
â”‚   â””â”€â”€ physical.yaml       # ç‰©ç†æ¥å£é…ç½®
â”œâ”€â”€ tunnels/
â”‚   â”œâ”€â”€ tunnel_ab.yaml     # éš§é“é…ç½®
â”‚   â””â”€â”€ ...
â””â”€â”€ policies/
    â”œâ”€â”€ vpn_traffic.json   # ç­–ç•¥ç»„é…ç½®
    â””â”€â”€ ...

/var/lib/trueword_node/
â”œâ”€â”€ rev/                    # æ’¤é”€å‘½ä»¤
â”œâ”€â”€ peer_configs/          # WireGuard å¯¹ç«¯é…ç½®
â””â”€â”€ check_results.json     # è¿é€šæ€§æ£€æŸ¥ç»“æœ
```

## ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»æŒæ¡äº†åŸºç¡€æ“ä½œï¼Œå¯ä»¥æ·±å…¥å­¦ä¹ ï¼š

- [æ¶æ„è®¾è®¡](architecture.md) - äº†è§£ç³»ç»Ÿæ ¸å¿ƒè®¾è®¡
- [WireGuard å®Œæ•´é…ç½®](tutorials/wireguard-setup.md) - WireGuard é«˜çº§ç”¨æ³•
- [GRE over IPsec é…ç½®](tutorials/gre-ipsec-setup.md) - ä¼ ç»ŸåŒå±‚éš§é“
- [ç­–ç•¥è·¯ç”±å®æˆ˜](tutorials/policy-routing.md) - å¤æ‚è·¯ç”±åœºæ™¯
- [æ•…éšœè½¬ç§»é…ç½®](tutorials/failover-setup.md) - é«˜å¯ç”¨æ–¹æ¡ˆ

## å¸¸è§é—®é¢˜

### Q: init æç¤ºæ‰¾ä¸åˆ°ç½‘ç»œæ¥å£ï¼Ÿ

A: ç¡®ä¿ä½ çš„ç½‘ç»œæ¥å£å·²é…ç½® IP åœ°å€ã€‚ä½¿ç”¨ `ip addr` æŸ¥çœ‹ã€‚

### Q: éš§é“åˆ›å»ºåæ— æ³• ping é€šï¼Ÿ

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ä¸¤ç«¯éš§é“éƒ½å·²å¯åŠ¨ï¼ˆ`twnode line list`ï¼‰
2. é˜²ç«å¢™å…è®¸ç›¸åº”ç«¯å£ï¼ˆWireGuard é»˜è®¤ 51820ï¼ŒIPsec 500/4500ï¼‰
3. å¯¹ç«¯ IP æ˜¯å¦æ­£ç¡®ï¼ˆ`twnode line list` æŸ¥çœ‹ï¼‰

### Q: WireGuard æ¡æ‰‹å¤±è´¥ï¼Ÿ

A: WireGuard é‡‡ç”¨"é™é»˜åè®®"ï¼Œé¦–æ¬¡æ¡æ‰‹éœ€è¦ 5-10 ç§’ã€‚å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å‘é€ ping åŒ…è§¦å‘æ¡æ‰‹ã€‚ç­‰å¾…ç‰‡åˆ»åé‡è¯•ã€‚

### Q: å¦‚ä½•æŸ¥çœ‹ WireGuard å¯¹ç«¯é…ç½®ï¼Ÿ

A: ä½¿ç”¨ `twnode line show-peer <éš§é“å>` æŸ¥çœ‹å·²ä¿å­˜çš„å¯¹ç«¯é…ç½®å‘½ä»¤ã€‚

---

**å¯¼èˆª**: [â† è¿”å›é¦–é¡µ](index.md) | [æ¶æ„è®¾è®¡ â†’](architecture.md)
